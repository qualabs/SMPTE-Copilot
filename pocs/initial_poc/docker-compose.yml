version: '3.8'

services:
  # Service for ingesting documents
  ingest:
    build: .
    image: rag-poc-v1
    volumes:
      # Mount database directory to persist data
      - ./chroma_db:/app/chroma_db
      # Mount data directory for PDFs
      - ./data:/app/data
      # Mount role mapping configuration
      - ./role_mapping.json:/app/role_mapping.json
    environment:
      - PYTHONUNBUFFERED=1
      - CHROMA_DB_PATH=/app/chroma_db
      - COLLECTION_NAME=rag_collection
    entrypoint: ["python", "ingest.py"]
    # Usage: docker-compose run --rm ingest /app/data/file.pdf --tags "Finance,Public"

  # Service for querying documents
  query:
    build: .
    image: rag-poc-v1
    volumes:
      # Mount database directory (read-only for queries)
      - ./chroma_db:/app/chroma_db
      # Mount role mapping configuration
      - ./role_mapping.json:/app/role_mapping.json
    environment:
      - PYTHONUNBUFFERED=1
      - CHROMA_DB_PATH=/app/chroma_db
      - COLLECTION_NAME=rag_collection
    entrypoint: ["python", "query.py"]
    # Usage: docker-compose run --rm query "your question" --role "Finance_Manager"
